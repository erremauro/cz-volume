(function($){'use strict';function ajaxRequest(data,onSuccess){$.post(CZVolumeAdmin.ajaxUrl,data).done(function(response){if(response && response.success){onSuccess(response);return}alert((response && response.data && response.data.message)|| CZVolumeAdmin.i18n.error)}).fail(function(){alert(CZVolumeAdmin.i18n.error)})}function renderSearchResults(items){var $tbody = $('#cz-search-results-body');var selectedId = parseInt($('#cz-post-id').val(),10)|| 0;var foundSelected = false;$tbody.empty();if(!items || !items.length){$tbody.append('<tr><td colspan="4">' + CZVolumeAdmin.i18n.searchEmpty + '</td></tr>');return}$.each(items,function(_,item){var title = $('<div>').text(item.title).html();var status = $('<div>').text(item.status).html();var actionHtml = item.already_added ? '<span class="cz-tag-added">Gia nel volume</span>':'<span class="cz-tag-available">Disponibile</span>';var selectableClass = item.already_added ? '':' is-selectable';var selectedClass = selectedId && selectedId === item.id ? ' is-selected':'';if(selectedClass){foundSelected = true}$tbody.append('<tr class="cz-search-row' + selectableClass + selectedClass + '" data-post-id="' + item.id + '" data-post-title="' + title + '">' + '<td class="cz-cell-id"><span class="cz-id-badge">#' + item.id + '</span></td>' + '<td class="cz-cell-title">' + title + '</td>' + '<td class="cz-cell-status"><span class="cz-status-pill">' + status + '</span></td>' + '<td class="cz-cell-action">' + actionHtml + '</td>' + '</tr>')});if(selectedId && !foundSelected){$('#cz-post-id').val('')}}$(function(){var $tbody = $('.wp-list-table tbody');var searchTimer = null;if($tbody.length && CZVolumeAdmin.volumeId){$tbody.sortable({handle:'.cz-drag-handle',items:'tr',axis:'y',update:function(){var positions = [];$tbody.find('tr').each(function(){var postId = $(this).data('post-id');if(postId){positions.push(postId)}});ajaxRequest({action:'cz_update_positions',nonce:CZVolumeAdmin.nonce,volume_id:CZVolumeAdmin.volumeId,positions:positions},function(){window.location.reload()})}})}$(document).on('click','.cz-remove-chapter',function(){if(!confirm(CZVolumeAdmin.i18n.confirmRemove)){return}var postId = $(this).data('post-id');if(!postId || !CZVolumeAdmin.volumeId){return}ajaxRequest({action:'cz_remove_chapter',nonce:CZVolumeAdmin.nonce,volume_id:CZVolumeAdmin.volumeId,post_id:postId},function(){window.location.reload()})});$('#cz-post-search').on('input',function(){var term = $.trim($(this).val());if(searchTimer){clearTimeout(searchTimer)}searchTimer = setTimeout(function(){if(term.length < 2){renderSearchResults([]);return}ajaxRequest({action:'cz_search_posts',nonce:CZVolumeAdmin.nonce,volume_id:CZVolumeAdmin.volumeId,term:term},function(response){renderSearchResults((response.data && response.data.items)|| [])})},300)});$(document).on('click','.cz-search-row.is-selectable',function(){var postId = $(this).data('post-id');if(!postId){return}$('#cz-post-id').val(postId);$('.cz-search-row.is-selected').removeClass('is-selected');$(this).addClass('is-selected')});$('#cz-add-chapter-form').on('submit',function(event){event.preventDefault();if(!$('#cz-post-id').val()){alert(CZVolumeAdmin.i18n.selectPost);return}var payload = $(this).serializeArray();var data ={};$.each(payload,function(_,field){data[field.name] = field.value});ajaxRequest(data,function(){window.location.reload()})});(function initVolumeTokenField(){var $tokenbox = $('#cz-volume-tokenbox');if(!$tokenbox.length){return}var $input = $('#cz-volume-token-input');var $chips = $('#cz-volume-chips');var $hidden = $('#cz-volume-hidden-inputs');var $suggestions = $('#cz-volume-suggestions');var volumes = [];try{volumes = JSON.parse($tokenbox.attr('data-volumes')|| '[]')}catch(e){volumes = []}function selectedIds(){var ids ={};$hidden.find('.cz-volume-hidden-input').each(function(){ids[String($(this).val())] = true});return ids}function escapeHtml(value){return $('<div>').text(value).html()}function addVolume(id,title){id = String(id);if(!id || selectedIds()[id]){return}$hidden.append('<input type="hidden" class="cz-volume-hidden-input" name="cz_post_volumes[]" value="' + escapeHtml(id)+ '" />');$chips.append('<span class="cz-volume-chip" data-volume-id="' + escapeHtml(id)+ '">' + escapeHtml(title)+ ' <button type="button" class="cz-chip-remove" aria-label="Rimuovi">Ã—</button>' + '</span>');updateMostUsedState()}function removeVolume(id){id = String(id);$hidden.find('.cz-volume-hidden-input[value="' + id + '"]').remove();$chips.find('.cz-volume-chip[data-volume-id="' + id + '"]').remove();updateMostUsedState()}function updateMostUsedState(){var ids = selectedIds();$('.cz-volume-most-used-link').each(function(){var isSelected = !!ids[String($(this).data('volume-id'))];$(this).toggleClass('is-selected',isSelected)})}function renderSuggestions(term){var query = $.trim(term || '').toLowerCase();var ids = selectedIds();var items = [];if(query.length){$.each(volumes,function(_,volume){var id = String(volume.id);var title =(volume.title || '').toString();if(!title || ids[id]){return}if(title.toLowerCase().indexOf(query)!== -1){items.push(volume)}})}$suggestions.empty();if(!items.length){$suggestions.attr('hidden',true);return}$.each(items.slice(0,8),function(_,volume){$suggestions.append('<button type="button" class="cz-volume-suggestion" data-volume-id="' + escapeHtml(String(volume.id))+ '" data-volume-title="' + escapeHtml(volume.title)+ '">' + escapeHtml(volume.title)+ '</button>')});$suggestions.attr('hidden',false)}$input.on('input',function(){renderSuggestions($(this).val())});$input.on('keydown',function(event){if(event.key !== 'Enter' && event.key !== ','){return}event.preventDefault();var $first = $suggestions.find('.cz-volume-suggestion').first();if($first.length){addVolume($first.data('volume-id'),$first.data('volume-title'));$input.val('');renderSuggestions('')}});$(document).on('click','.cz-volume-suggestion',function(){addVolume($(this).data('volume-id'),$(this).data('volume-title'));$input.val('').trigger('focus');renderSuggestions('')});$(document).on('click','.cz-chip-remove',function(){removeVolume($(this).closest('.cz-volume-chip').data('volume-id'))});$(document).on('click','.cz-volume-most-used-link',function(event){event.preventDefault();addVolume($(this).data('volume-id'),$(this).data('volume-title'));$input.trigger('focus')});$(document).on('click',function(event){if(!$(event.target).closest('#cz-volume-tokenbox').length){$suggestions.attr('hidden',true)}});updateMostUsedState()})();(function initVolumeMediaFields(){if(!CZVolumeAdmin.volumeEditor){return}function renderPreview($targetPreview,type,attachment){if(type === 'image'){var url =(attachment.sizes && attachment.sizes.medium && attachment.sizes.medium.url)|| attachment.url;$targetPreview.html('<img src="' + $('<div>').text(url).html()+ '" alt="" />');return}$targetPreview.html('<a href="' + $('<div>').text(attachment.url).html()+ '" target="_blank" rel="noopener noreferrer">' + $('<div>').text(attachment.filename || attachment.title || 'file').html()+ '</a>')}$(document).on('click','.cz-media-upload',function(){var $button = $(this);var targetId = $button.data('target-id');var targetPreview = $button.data('target-preview');var type = $button.data('type');var libraryType = type === 'image' ? 'image':'';var frame = wp.media({title:'Seleziona file',button:{text:'Usa questo file'},library:libraryType ?{type:libraryType}:{},multiple:false});frame.on('select',function(){var attachment = frame.state().get('selection').first().toJSON();var filename =(attachment.filename || '').toLowerCase();var mime =(attachment.mime || '').toLowerCase();if(type === 'epub' && !/\.epub$/.test(filename)){alert('Seleziona un file EPUB(.epub).');return}if(type === 'pdf' && mime !== 'application/pdf'){alert('Seleziona un file PDF(.pdf).');return}$(targetId).val(attachment.id);renderPreview($(targetPreview),type,attachment)});frame.open()});$(document).on('click','.cz-media-remove',function(){var $button = $(this);var targetId = $button.data('target-id');var targetPreview = $button.data('target-preview');var isImage = String(targetId).indexOf('cover')!== -1;$(targetId).val('');if(isImage){$(targetPreview).html('<span class="cz-media-placeholder">Nessuna immagine selezionata</span>')}else if(String(targetId).indexOf('epub')!== -1){$(targetPreview).html('<span class="cz-media-placeholder">Nessun file EPUB</span>')}else{$(targetPreview).html('<span class="cz-media-placeholder">Nessun file PDF</span>')}})})()})})(jQuery);